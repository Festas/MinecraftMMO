
######################################
# Blocking
######################################

mitigation_on_block:
  mechanics:

    # First, compute block coefficient and reduce damage
    - 'set_double{variable="block_coef";value="<stat.block_power>/100"}'
    - 'multiply_damage{amount="1 - <block_coef>"}'

    # Send message and play sound effect
    - 'set_double{variable="damaged_blocked";value="<attack.damage> * <block_coef>"}'
    - 'action_bar{m="&cYou blocked <damaged_blocked> damage!";target=caster;priority=31}'
    - 'play_sound{sound=ENTITY_ZOMBIE_ATTACK_IRON_DOOR;volume=1;pitch=2}'
    - 'set_double{variable=max_angle;value=120}'
    - 'script{name=mitigation_block_particle_effect}'

# Used for both slashing and piercing
mitigation_block_particle_effect:
  mechanics:
    - 'copy_vector{variable=dir;value=target.location}'
    - 'copy_vector{variable=src;value=caster.location}'
    - 'subtract_vector{variable=dir;value=caster.location}'
    - 'script{name=mitigation_block_particle_effect_1;counter=counter_a;iterations=10}'

mitigation_block_particle_effect_1:
  mechanics:
    - 'script{name=mitigation_block_particle_effect_2;counter=counter_z;iterations=8}'

mitigation_block_particle_effect_2:
  mechanics:
    - 'set_double{variable=angle;value="PI / 180.0 * (<dir.yaw> + 90 + <max_angle> * ( <counter_a> / 10 - 0.5))"}'
    - 'copy_vector{variable=inter;value=src}'
    - 'add_vector{variable=inter;x="cos(<angle>)";y=".25 + <counter_z> * 1.5/8";z="sin(<angle>)"}'
    - 'particle{particle=REDSTONE;target={type=variable;name=inter};color={red=128;green=128;blue=128}}'
    - 'script{name=mitigation_block_particle_effect_3;target_location={type=variable;name=inter}}'

mitigation_block_particle_effect_3:
  conditions:
    - 'chance{c=0.1}'
  mechanics:
    - 'particle{particle=CRIT;speed=.3}'

######################################
# Dodging
######################################

mitigation_on_dodge:
  mechanics:

    - 'cancel_event{}' # Negate all damage
    - 'set_no_damage_ticks{target=caster;ticks=10}' # Briefly make the player invincible to avoid damage stacking

    # Send message, play sound and particle effect
    - 'action_bar{m="&cYou dodged <attack.damage> damage!";target=caster;priority=31}'
    - 'play_sound{sound=ENTITY_ENDER_DRAGON_FLAP;volume=1;pitch=1}'
    - 'particle{particle=POOF;target=caster;amount=16;x=.5;y=.5;z=.5}'
    - 'script{name=mitigation_dodge_knockback}'

mitigation_dodge_knockback:
  conditions:
    - 'variable_exists{var=target}' # only if target exists
  mechanics:
    - 'copy_vector{var=dir;val=target.location}'
    - 'sub_vector{var=dir;val=caster.location}'
    - 'multiply_vector{var=dir;value=-1}'
    - 'set_y{var=dir;y=0}'
    - 'normalize_vector{var=dir}'
    - 'set_y{var=dir;y=0.35}'
    - 'set_velocity{vector=dir;target=caster}'

######################################
# Parrying
######################################

mitigation_on_parry:
  mechanics:

    - 'cancel_event{}' # Negate all damage
    - 'set_no_damage_ticks{target=caster;ticks=10}' # Briefly make the player invincible to avoid damage stacking

    # Send message, play sound and particle effect
    - 'action_bar{m="&cYou parried <attack.damage> damage!";target=caster;priority=31}'
    - 'play_sound{sound=ENTITY_ENDER_DRAGON_FLAP;volume=1;pitch=1}'
    - 'particle{particle=POOF;target=caster;amount=16;x=.5;y=.5;z=.5}'
    - 'script{name=mitigation_parry_knockback}'

mitigation_parry_knockback:
  conditions:
    - 'variable_exists{var=target}' # only if target exists
  mechanics:
    - 'copy_vector{var=dir;val=target.location}'
    - 'sub_vector{var=dir;val=caster.location}'
    - 'set_y{var=dir;y=0}'
    - 'normalize_vector{var=dir}'
    - 'set_y{var=dir;y=0.35}'
    - 'set_velocity{vector=dir}'


