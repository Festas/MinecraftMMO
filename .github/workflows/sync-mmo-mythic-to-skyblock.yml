name: Sync MMO & Mythic Plugins RPG â†’ Skyblock

on:
  push:
    branches:
      - main
    paths:
      # MMO Plugins
      - 'rpg/plugins/MMOCore/**'
      - 'rpg/plugins/MMOItems/**'
      # Mythic Plugins
      - 'rpg/plugins/MythicAchievements/**'
      - 'rpg/plugins/MythicDungeons/**'
      - 'rpg/plugins/MythicHUD/**'
      - 'rpg/plugins/MythicLib/**'
      - 'rpg/plugins/MythicMobs/**'
      - 'rpg/plugins/MythicRPG/**'
      # Wirtschaftssystem
      - 'rpg/plugins/CoinsEngine/**'
      - 'rpg/plugins/DeluxeBazaar/**'
      - 'rpg/plugins/GlobalMarketPlus/**'
      - 'rpg/plugins/Vault/**'
      # Rose Plugins
      - 'rpg/plugins/RoseGarden/**'
      - 'rpg/plugins/RoseLoot/**'
      - 'rpg/plugins/RoseStacker/**'
      # CMI
      - 'rpg/plugins/CMI/**'
      - 'rpg/plugins/CMILib/**'
      # Aurora Plugins
      - 'rpg/plugins/Aurora/**'
      - 'rpg/plugins/AuroraCollections/**'

  workflow_dispatch:
    inputs:
      sync_all:
        description: 'Alle MMO & Mythic Ordner synchronisieren?'
        required: false
        type: boolean
        default: true

jobs:
  sync-to-skyblock-repo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_TOKEN }}
          fetch-depth: 0

      - name: Sync Plugins to Skyblock folder
        run: |
          echo "ğŸ”„ Synchronisiere Plugins von RPG nach Skyblock..."
          
          # Liste der zu synchronisierenden Ordner
          PLUGINS=(
            # MMO Plugins
            "MMOCore"
            "MMOItems"
            # Mythic Plugins
            "MythicAchievements"
            "MythicDungeons"
            "MythicHUD"
            "MythicLib"
            "MythicMobs"
            "MythicRPG"
            # Wirtschaftssystem
            "CoinsEngine"
            "DeluxeBazaar"
            "GlobalMarketPlus"
            "Vault"
            # Rose Plugins
            "RoseGarden"
            "RoseLoot"
            "RoseStacker"
            # CMI
            "CMI"
            "CMILib"
            # Aurora Plugins
            "Aurora"
            "AuroraCollections"
          )
          
          # Skyblock plugins Verzeichnis erstellen falls nicht vorhanden
          mkdir -p skyblock/plugins
          
          for PLUGIN in "${PLUGINS[@]}"; do
            SOURCE="rpg/plugins/$PLUGIN"
            DEST="skyblock/plugins/$PLUGIN"
            
            if [ -d "$SOURCE" ]; then
              echo "ğŸ“‚ Synchronisiere $PLUGIN..."
              
              # LÃ¶sche Zielordner komplett und kopiere neu (vollstÃ¤ndiger Sync inkl. LÃ¶schungen)
              rm -rf "$DEST"
              cp -r "$SOURCE" "$DEST"
              
              echo "âœ… $PLUGIN erfolgreich synchronisiert"
            else
              # Wenn Quellordner nicht mehr existiert, lÃ¶sche auch den Zielordner
              if [ -d "$DEST" ]; then
                echo "ğŸ—‘ï¸ $SOURCE wurde gelÃ¶scht, entferne auch $DEST..."
                rm -rf "$DEST"
                echo "âœ… $PLUGIN aus Skyblock entfernt"
              fi
            fi
          done

      - name: Commit and Push Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # -A erfasst auch LÃ¶schungen
          git add -A skyblock/plugins/
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ Keine Ã„nderungen gefunden."
          else
            # Zeige was sich geÃ¤ndert hat (inkl. LÃ¶schungen)
            echo "ğŸ“‹ Ã„nderungen:"
            git diff --staged --stat
            
            git commit -m "ğŸ”„ Auto-sync plugins from RPG to Skyblock

            Synchronisierte Plugins:
            - MMOCore, MMOItems
            - MythicAchievements, MythicDungeons, MythicHUD
            - MythicLib, MythicMobs, MythicRPG
            - CoinsEngine, DeluxeBazaar, GlobalMarketPlus, Vault
            - RoseGarden, RoseLoot, RoseStacker
            - CMI, CMILib
            - Aurora, AuroraCollections
            
            Inkl. LÃ¶schungen und Aktualisierungen."
            
            git remote set-url origin https://x-access-token:${{ secrets.PERSONAL_TOKEN }}@github.com/${{ github.repository }}
            
            # Try to pull and rebase, if conflicts occur abort and try a fast-forward only pull
            if ! git pull --rebase origin main; then
              echo "âš ï¸ Rebase conflict detected, aborting and trying fast-forward only pull..."
              git rebase --abort
              if ! git pull --ff-only origin main; then
                echo "âŒ Fast-forward pull failed, manual intervention required"
                exit 1
              fi
            fi
            
            git push
            echo "âœ… Ã„nderungen erfolgreich gepusht!"
          fi

  deploy-to-skyblock-server:
    needs: sync-to-skyblock-repo
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy Plugins to Skyblock Server
        run: |
          echo "ğŸ“¤ Deploye Plugins zum Skyblock Server..."
          
          PLUGINS=(
            # MMO Plugins
            "MMOCore"
            "MMOItems"
            # Mythic Plugins
            "MythicAchievements"
            "MythicDungeons"
            "MythicHUD"
            "MythicLib"
            "MythicMobs"
            "MythicRPG"
            # Wirtschaftssystem
            "CoinsEngine"
            "DeluxeBazaar"
            "GlobalMarketPlus"
            "Vault"
            # Rose Plugins
            "RoseGarden"
            "RoseLoot"
            "RoseStacker"
            # CMI
            "CMI"
            "CMILib"
            # Aurora Plugins
            "Aurora"
            "AuroraCollections"
          )
          
          for PLUGIN in "${PLUGINS[@]}"; do
            LOCAL_DIR="skyblock/plugins/$PLUGIN"
            
            if [ -d "$LOCAL_DIR" ]; then
              echo "ğŸ“‚ Deploye $PLUGIN..."
              
              # --delete sorgt dafÃ¼r, dass gelÃ¶schte Dateien auch auf dem Server entfernt werden
              rsync -avz --delete \
                --exclude='*.jar' \
                --exclude='*.jar.disabled' \
                -e "ssh -o StrictHostKeyChecking=no" \
                "$LOCAL_DIR/" \
                "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SERVER_PATH_SKYBLOCK }}/$PLUGIN/"
              
              echo "âœ… $PLUGIN deployed"
            else
              # Plugin wurde gelÃ¶scht - entferne es auch vom Server
              echo "ğŸ—‘ï¸ $PLUGIN existiert nicht mehr lokal, entferne vom Server..."
              # Safely construct the path and verify it's not empty
              REMOTE_PATH="${{ secrets.SERVER_PATH_SKYBLOCK }}/$PLUGIN"
              if [ -n "$REMOTE_PATH" ] && [ "$PLUGIN" != "" ]; then
                ssh -o StrictHostKeyChecking=no \
                  "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" \
                  "if [ -d \"$REMOTE_PATH\" ]; then rm -rf \"$REMOTE_PATH\"; fi" 2>/dev/null || true
                echo "âœ… $PLUGIN vom Server entfernt"
              else
                echo "âš ï¸ Invalid remote path, skipping deletion"
              fi
            fi
          done
          
          echo "ğŸ‰ Alle Plugins erfolgreich deployed!"
