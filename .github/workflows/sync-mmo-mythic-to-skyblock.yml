name: Sync MMO & Mythic Plugins RPG â†’ Skyblock

on:
  push: 
    branches: 
      - main
    paths:
      # MMO Plugins
      - 'rpg/plugins/MMOCore/**'
      - 'rpg/plugins/MMOItems/**'
      # Mythic Plugins
      - 'rpg/plugins/MythicAchievements/**'
      - 'rpg/plugins/MythicDungeons/**'
      - 'rpg/plugins/MythicHUD/**'
      - 'rpg/plugins/MythicLib/**'
      - 'rpg/plugins/MythicMobs/**'
      - 'rpg/plugins/MythicRPG/**'

  workflow_dispatch: 
    inputs:
      sync_all:
        description: 'Alle MMO & Mythic Ordner synchronisieren?'
        required: false
        type: boolean
        default: true

jobs: 
  sync-to-skyblock-repo:
    runs-on: ubuntu-latest
    steps: 
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_TOKEN }}
          fetch-depth: 0

      - name: Sync MMO & Mythic Plugins to Skyblock folder
        run: |
          echo "ðŸ”„ Synchronisiere MMO & Mythic Plugins von RPG nach Skyblock..."
          
          # Liste der zu synchronisierenden Ordner
          PLUGINS=(
            "MMOCore"
            "MMOItems"
            "MythicAchievements"
            "MythicDungeons"
            "MythicHUD"
            "MythicLib"
            "MythicMobs"
            "MythicRPG"
          )
          
          # Skyblock plugins Verzeichnis erstellen falls nicht vorhanden
          mkdir -p skyblock/plugins
          
          for PLUGIN in "${PLUGINS[@]}"; do
            SOURCE="rpg/plugins/$PLUGIN"
            DEST="skyblock/plugins/$PLUGIN"
            
            if [ -d "$SOURCE" ]; then
              echo "ðŸ“‚ Synchronisiere $PLUGIN..."
              
              # LÃ¶sche Zielordner komplett und kopiere neu (vollstÃ¤ndiger Sync inkl. LÃ¶schungen)
              rm -rf "$DEST"
              cp -r "$SOURCE" "$DEST"
              
              echo "âœ… $PLUGIN erfolgreich synchronisiert"
            else
              # Wenn Quellordner nicht mehr existiert, lÃ¶sche auch den Zielordner
              if [ -d "$DEST" ]; then
                echo "ðŸ—‘ï¸ $SOURCE wurde gelÃ¶scht, entferne auch $DEST..."
                rm -rf "$DEST"
                echo "âœ… $PLUGIN aus Skyblock entfernt"
              fi
            fi
          done

      - name: Commit and Push Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # -A erfasst auch LÃ¶schungen
          git add -A skyblock/plugins/
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ Keine Ã„nderungen gefunden."
          else
            # Zeige was sich geÃ¤ndert hat (inkl. LÃ¶schungen)
            echo "ðŸ“‹ Ã„nderungen:"
            git diff --staged --stat
            
            git commit -m "ðŸ”„ Auto-sync MMO & Mythic plugins from RPG to Skyblock

            Synchronisierte Plugins:
            - MMOCore, MMOItems
            - MythicAchievements, MythicDungeons, MythicHUD
            - MythicLib, MythicMobs, MythicRPG
            
            Inkl. LÃ¶schungen und Aktualisierungen."
            
            git remote set-url origin https://x-access-token:${{ secrets.PERSONAL_TOKEN }}@github.com/${{ github.repository }}
            
            # Try to pull and rebase, if conflicts occur abort and try a simple pull
            if ! git pull --rebase origin main; then
              echo "âš ï¸ Rebase conflict detected, aborting and trying regular pull..."
              git rebase --abort
              if ! git pull --no-rebase origin main; then
                echo "âŒ Pull failed, manual intervention required"
                exit 1
              fi
            fi
            
            git push
            echo "âœ… Ã„nderungen erfolgreich gepusht!"
          fi

  deploy-to-skyblock-server:
    needs: sync-to-skyblock-repo
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy MMO & Mythic to Skyblock Server
        run: |
          echo "ðŸ“¤ Deploye MMO & Mythic Plugins zum Skyblock Server..."
          
          PLUGINS=(
            "MMOCore"
            "MMOItems"
            "MythicAchievements"
            "MythicDungeons"
            "MythicHUD"
            "MythicLib"
            "MythicMobs"
            "MythicRPG"
          )
          
          for PLUGIN in "${PLUGINS[@]}"; do
            LOCAL_DIR="skyblock/plugins/$PLUGIN"
            
            if [ -d "$LOCAL_DIR" ]; then
              echo "ðŸ“‚ Deploye $PLUGIN..."
              
              # --delete sorgt dafÃ¼r, dass gelÃ¶schte Dateien auch auf dem Server entfernt werden
              rsync -avz --delete \
                --exclude='*.jar' \
                --exclude='*.jar.disabled' \
                -e "ssh -o StrictHostKeyChecking=no" \
                "$LOCAL_DIR/" \
                "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SERVER_PATH_SKYBLOCK }}/$PLUGIN/"
              
              echo "âœ… $PLUGIN deployed"
            else
              # Plugin wurde gelÃ¶scht - entferne es auch vom Server
              echo "ðŸ—‘ï¸ $PLUGIN existiert nicht mehr lokal, entferne vom Server..."
              ssh -o StrictHostKeyChecking=no \
                "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" \
                "rm -rf ${{ secrets.SERVER_PATH_SKYBLOCK }}/$PLUGIN" 2>/dev/null || true
              echo "âœ… $PLUGIN vom Server entfernt"
            fi
          done
          
          echo "ðŸŽ‰ Alle Plugins erfolgreich deployed!"
