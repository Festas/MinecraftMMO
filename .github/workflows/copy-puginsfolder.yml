name: Sync Plugin Configs

on:
  workflow_dispatch:
    inputs:
      server: 
        description: 'Server auswÃ¤hlen'
        required: true
        type: choice
        options:
          - LOBBY
          - PROXY
          - RPG
          - SKYBLOCK
          - SURVIVAL
      direction:
        description: 'Sync-Richtung'
        required: true
        type: choice
        options:
          - 'Server â†’ Repo'
          - 'Repo â†’ Server'

jobs: 
  sync-plugins:
    runs-on: ubuntu-latest
    steps: 
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_TOKEN }}

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Sync Plugins
        run: |
          SERVER_NAME="${{ github.event.inputs.server }}"
          DIRECTION="${{ github.event.inputs.direction }}"
          
          # Dynamisch den richtigen Secret-Pfad auswÃ¤hlen
          case $SERVER_NAME in
            LOBBY)
              SERVER_PATH="${{ secrets.SERVER_PATH_LOBBY }}"
              ;;
            PROXY)
              SERVER_PATH="${{ secrets.SERVER_PATH_PROXY }}"
              ;;
            RPG)
              SERVER_PATH="${{ secrets.SERVER_PATH_RPG }}"
              ;;
            SKYBLOCK)
              SERVER_PATH="${{ secrets.SERVER_PATH_SKYBLOCK }}"
              ;;
            SURVIVAL)
              SERVER_PATH="${{ secrets.SERVER_PATH_SURVIVAL }}"
              ;;
          esac
          
          # Lokaler Ordner
          LOCAL_DIR="${SERVER_NAME,,}/plugins"  # lowercase
          
          if [ "$DIRECTION" == "Server â†’ Repo" ]; then
            echo "ðŸ“¥ Kopiere vom Server zum Repository..."
            mkdir -p "$LOCAL_DIR"
            
            # Rsync: Server â†’ Repo
            rsync -avz --delete \
              --exclude='*.jar' \
              --exclude='*.jar.disabled' \
              -e "ssh -o StrictHostKeyChecking=no" \
              "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${SERVER_PATH}/" \
              "$LOCAL_DIR/"
          else
            echo "ðŸ“¤ Kopiere vom Repository zum Server..."
            
            # Rsync: Repo â†’ Server
            rsync -avz --delete \
              --exclude='*.jar' \
              --exclude='*.jar.disabled' \
              -e "ssh -o StrictHostKeyChecking=no" \
              "$LOCAL_DIR/" \
              "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${SERVER_PATH}/"
          fi

      - name: Commit and Push Changes
        if: github.event.inputs.direction == 'Server â†’ Repo'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          SERVER_NAME="${{ github.event.inputs.server }}"
          LOCAL_DIR="${SERVER_NAME,,}/plugins"
          
          git add "$LOCAL_DIR"
          
          if git diff --staged --quiet; then
            echo "Keine Ã„nderungen gefunden."
          else
            git commit -m "ðŸ”„ Sync $SERVER_NAME plugin configs from server"
            git remote set-url origin https://x-access-token:${{ secrets.PERSONAL_TOKEN }}@github.com/${{ github.repository }}
            
            # Pull remote changes and rebase before pushing
            git pull --rebase origin main || {
              echo "Rebase conflict detected. Aborting and retrying..."
              git rebase --abort
              git pull --rebase origin main
            }
            
            git push
          fi
