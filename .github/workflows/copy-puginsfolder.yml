name: Sync Plugin Configs from Server

on:
  workflow_dispatch:
    inputs:
      server: 
        description: 'Server auswÃ¤hlen'
        required: true
        type: choice
        options:
          - LOBBY
          - PROXY
          - RPG
          - SKYBLOCK
          - SURVIVAL

jobs: 
  sync-plugins:
    runs-on: ubuntu-latest
    steps: 
      - name:  Checkout Repository
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Sync Plugin Configs from Server
        run: |
          SERVER_NAME="${{ github.event. inputs.server }}"
          
          # Dynamisch den richtigen Secret-Pfad auswÃ¤hlen
          case $SERVER_NAME in
            LOBBY)
              SERVER_PATH="${{ secrets.SERVER_PATH_LOBBY }}"
              ;;
            PROXY)
              SERVER_PATH="${{ secrets.SERVER_PATH_PROXY }}"
              ;;
            RPG)
              SERVER_PATH="${{ secrets. SERVER_PATH_RPG }}"
              ;;
            SKYBLOCK)
              SERVER_PATH="${{ secrets.SERVER_PATH_SKYBLOCK }}"
              ;;
            SURVIVAL)
              SERVER_PATH="${{ secrets.SERVER_PATH_SURVIVAL }}"
              ;;
          esac
          
          # Zielordner erstellen
          TARGET_DIR="${SERVER_NAME,,}/plugins"  # lowercase
          mkdir -p "$TARGET_DIR"
          
          # Rsync: Plugins kopieren, .jar Dateien ausschlieÃŸen
          rsync -avz --delete \
            --exclude='*.jar' \
            --exclude='*.jar.disabled' \
            -e "ssh -o StrictHostKeyChecking=no" \
            "${{ secrets. SSH_USER }}@${{ secrets.SSH_HOST }}:${SERVER_PATH}/" \
            "$TARGET_DIR/"

      - name: Commit and Push Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users. noreply.github.com"
          
          SERVER_NAME="${{ github.event.inputs.server }}"
          
          git add .
          
          if git diff --staged --quiet; then
            echo "Keine Ã„nderungen gefunden."
          else
            git commit -m "ðŸ”„ Sync $SERVER_NAME plugin configs from server"
            git push
          fi
